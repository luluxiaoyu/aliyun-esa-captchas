<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESA 验证码微服务调试台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .disabled-area { opacity: 0.6; pointer-events: none; filter: grayscale(1); transition: all 0.3s; }
        .code-block { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center p-4">

    <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <div class="bg-slate-800 p-5 text-white flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-server"></i> 验证码验签微服务
                </h1>
                <p class="text-slate-400 text-xs mt-1">模拟后端调用 /api/captcha 接口</p>
            </div>
            <button onclick="window.location.reload()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition">
                <i class="fa-solid fa-rotate-right"></i> 重置
            </button>
        </div>

        <div class="p-6 space-y-6">
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-3">
                    <span class="bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded">CONFIG</span>
                    <span class="text-xs text-blue-800 font-bold">环境配置</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">身份标 (Prefix)</label>
                        <input type="text" id="conf-prefix" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">场景ID (SceneId)</label>
                        <input type="text" id="conf-scene" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">后端密钥 (Secret)</label>
                        <input type="text" id="conf-secret" placeholder="ESA Env SERVER_SECRET" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm focus:border-blue-500 outline-none font-mono text-red-600">
                    </div>
                </div>

                <button id="btn-init" onclick="initEnvironment()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md text-sm font-bold shadow transition">
                    保存配置并加载 SDK
                </button>
            </div>

            <div id="test-area" class="disabled-area space-y-6">
                
                <div class="pl-4 border-l-2 border-gray-200 relative">
                    <div class="absolute -left-1.5 top-0 w-3 h-3 rounded-full bg-gray-300"></div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">Step 1: 前端唤起验证码</h3>
                    
                    <div class="bg-white border rounded-lg p-4 shadow-sm">
                        <div id="captcha-element" class="mb-3"></div>
                        
                        <button id="btn-verify" class="px-4 py-2 bg-gray-800 text-white rounded text-sm hover:bg-gray-900 transition flex items-center gap-2">
                            <i class="fa-solid fa-shield-halved"></i> 点击验证
                        </button>
                    </div>
                </div>

                <div class="pl-4 border-l-2 border-gray-200 relative">
                    <div class="absolute -left-1.5 top-0 w-3 h-3 rounded-full bg-gray-300"></div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">Step 2: 模拟后端验签 (GET /api/captcha)</h3>
                    
                    <div class="bg-gray-50 border rounded-lg p-4">
                        <div class="text-xs text-gray-500 mb-2 font-mono break-all">
                            GET /api/captcha?secret=<span class="text-red-500 font-bold" id="preview-secret">...</span>&captcha_verify_param=<span class="text-blue-500 font-bold" id="preview-param">...</span>
                        </div>
                        
                        <div id="result-box" class="hidden mt-3 p-3 rounded border text-sm"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // 常量
        const API_URL = '/api/captcha'; // ESA 接口地址
        const STORE_KEYS = ['esa_p', 'esa_s', 'esa_k']; // LocalStorage Keys

        // 页面加载恢复配置
        window.addEventListener('DOMContentLoaded', () => {
            const [p, s, k] = STORE_KEYS.map(key => localStorage.getItem(key));
            if(p) document.getElementById('conf-prefix').value = p;
            if(s) document.getElementById('conf-scene').value = s;
            if(k) document.getElementById('conf-secret').value = k;
        });

        // 初始化
        function initEnvironment() {
            const prefix = document.getElementById('conf-prefix').value.trim();
            const scene = document.getElementById('conf-scene').value.trim();
            const secret = document.getElementById('conf-secret').value.trim();

            if(!prefix || !scene || !secret) {
                alert("请填写所有配置项 (身份标, 场景ID, 密钥)");
                return;
            }

            // 保存配置
            localStorage.setItem('esa_p', prefix);
            localStorage.setItem('esa_s', scene);
            localStorage.setItem('esa_k', secret);

            // 更新预览
            document.getElementById('preview-secret').innerText = secret;

            // 设置 SDK 全局变量
            window.AliyunCaptchaConfig = { region: "cn", prefix: prefix };

            // 动态加载 SDK
            const btn = document.getElementById('btn-init');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 加载中...';
            btn.disabled = true;

            const script = document.createElement('script');
            script.src = 'https://o.alicdn.com/captcha-frontend/aliyunCaptcha/AliyunCaptcha.js';
            script.onload = () => {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> SDK 已就绪';
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                btn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                
                document.getElementById('test-area').classList.remove('disabled-area');
                setupCaptcha(scene, secret);
            };
            script.onerror = () => {
                alert("SDK 加载失败，请检查网络");
                btn.disabled = false;
                btn.innerText = "重试";
            };
            document.head.appendChild(script);
        }

        // 配置验证码实例
        function setupCaptcha(sceneId, secret) {
            window.initAliyunCaptcha({
                SceneId: sceneId,
                mode: "popup",
                element: "#captcha-element",
                button: "#btn-verify",
                slideStyle: { width: 320, height: 40 },
                language: "cn",
                
                // 验证成功回调
                success: async function(verifyParam) {
                    console.log("前端验证成功:", verifyParam);
                    document.getElementById('preview-param').innerText = verifyParam.substring(0, 20) + "...";
                    
                    // 立即模拟后端请求
                    await callBackendApi(verifyParam, secret);
                },
                fail: (e) => console.error(e)
            });
        }

        // 模拟后端调用 API
        async function callBackendApi(verifyParam, secret) {
            const resultBox = document.getElementById('result-box');
            resultBox.classList.remove('hidden', 'bg-green-50', 'border-green-200', 'bg-red-50', 'border-red-200');
            resultBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 正在请求 ESA 验签接口...';

            try {
                // 构建 URL (GET 请求 + Query 参数)
                const targetUrl = `${API_URL}?captcha_verify_param=${encodeURIComponent(verifyParam)}&secret=${encodeURIComponent(secret)}`;
                
                const response = await fetch(targetUrl, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.code === 0) {
                    // 成功 T001
                    resultBox.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                    resultBox.innerHTML = `
                        <div class="flex items-center gap-2 font-bold text-lg">
                            <i class="fa-solid fa-circle-check"></i> ${data.msg}
                        </div>
                        <div class="mt-1 text-xs opacity-75 font-mono">CODE: T001 | REQ_ID: ${data.data?.req_id}</div>
                    `;
                } else {
                    // 失败 (各种 F 开头的错误)
                    resultBox.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                    resultBox.innerHTML = `
                        <div class="flex items-center gap-2 font-bold">
                            <i class="fa-solid fa-circle-xmark"></i> ${data.msg}
                        </div>
                        <div class="mt-2 text-xs bg-white p-2 rounded border border-red-100 font-mono">
                            ERROR_CODE: ${data.data?.verify_code || 'Unknown'}<br>
                            ${data.data?.tip ? 'TIP: ' + data.data.tip : ''}
                        </div>
                    `;
                }

            } catch (e) {
                resultBox.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                resultBox.innerText = "请求发生网络错误: " + e.message;
            }
        }
    </script>
</body>
</html>
